env:
- name: DEPLOY_NAMESPACE
  value: jx-staging
pipelineConfig:
  env:
  - name: DEPLOY_NAMESPACE
    value: jx-staging
  pipelines:
    release:
      preBuild:
        steps:
        - sh: jx get vault-config
        - sh: >-
            eval $(jx get vault-config) &&
            curl -L https://github.com/starkandwayne/safe/releases/download/v1.3.4/safe-linux-amd64 --output ./safe-linux-amd64 &&
            chmod +x ./safe-linux-amd64 &&
            sudo mv ./safe-linux-amd64 /usr/bin/safe &&
            wget https://bintray.com/loadimpact/rpm/rpm -O bintray-loadimpact-rpm.repo &&
            mv bintray-loadimpact-rpm.repo /etc/yum.repos.d/ &&
            yum -y install k6 &&
            url=https://demo-app-jx-staging.cloudnativeentrepreneur.dev
            users=1000
            slackUrl=$(safe get secret/staging/k6:slackUrl)
            k6 --quiet run ./load-test.js
          name: load-test